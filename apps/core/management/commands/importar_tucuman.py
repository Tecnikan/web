import json

from django.core.management.base import BaseCommand

from apps.catastro.models import Ciudad
from apps.core.models import Linea, Recorrido


class Command(BaseCommand):
    """ Importa recorridos de la ciudad de Tucum√°n desde un archivo json

        Ejemplo de un documento:

        {
            "imagen": "http://....png",
            "color": "#FF0000",
            "id": "83",
            "conectarExtremos": false,
            "ruta": [
                [lng, lat],
                ...
            ],
            "inicio": "Ruta Provincial 380",
            "imagenGrande": "http://....png",
            "nombre": "San Pablo x Ruta 301",
            "codigo": "px`cDvwrmKgA`KqAdMeMsBoIoAcGeAp@eHcIcFqGoF}DqFkGuIeC_EuCmEm@}@eAqAmG_JqCaDOw@gC_EgJoNqPgWoPiVuPmX_EoGeE_GmFwHmF{HgEuGcF{HiKsQ}MwSgJ}NaIqL{QqYcCyFkAeFaAmHW{IN_F`A{KV}B^{E`@yEn@kGp@yGdAiJv@yFv@kGt@kGn@yFt@iFp@{Ev@sFn@uEf@oE|@iHl@gFt@gGv@cHfAwIx@eHh@iFj@gFb@wDb@cDeAUmDk@_D]cCe@uDi@kB_@gC[gC]qAQsBYcB[ZeCXoC`@aD\\yCXcCXiCj@sERaCb@kDXeC\\aDZ{Cf@aD`@{C^gC`@sC`@wCb@{Cb@yCd@}C\\yBf@eD^cCj@kDd@wC\\wBh@eD^eC?s@_Ca@eDg@eDe@}Dq@yB[_BU}Cg@mB]uCc@{B_@yCe@qCa@cDe@qBU}Cg@uB]kDk@_BWoC]qB]uCa@qCc@Lr@WzC_@`D]jDQrBc@dES`B_@pDSrBi@xDUxBc@jDQnAc@tD[dCc@rD[xBi@fEY`CQ`Be@tErB\\nC`@vC^pBX_@bCe@bD~B`@rCh@nCb@rCd@vCd@vB^xB^lDj@jCf@dC`@|Bb@xAZjCd@jDp@pCj@`C^bB^bCf@nB\\jCf@]|Be@dD[`Cc@rCm@hDW~AUZ`Db@|B\\lFx@`C\\zCf@tBVbC`@dANNb@@h@AT[rCc@fDc@tCo@`Gm@nFg@fEi@fEe@fEm@xEe@jEs@dFa@bDw@nGu@zFq@dF]~B[lCk@vEm@hE[tCy@fHe@hDm@jFw@~Gm@tF]pDq@fGs@rGWpCe@dF[nDEhA?vACrB^zHJxCpBbItBxFrHbMtH`MrJhObMfRnJpN`J~NdItM|J`OvHtKjJvN|GzJfKfPdJtNfIjLhEvGxCvEbEdGv@rBHpA@p@MlAHb@RZ^Lj@Hz@HjAZ`Az@bAxAlCxDvAzBb@\\h@^JNVd@rBxCtCtE|CpEnCjDbCjDj@~@`G`FbCzAlBnArAx@g@tGbF`AdLlB~Cn@fFz@l@gFhAaJt@aH",
            "fin": "Marcos Paz 700",
            "wkt": "LINESTRING(-65.3095684779 -26.8789787645, -65.3114930272 -26.8786180985, -65.3137696813 -26.8782002482, -65.3131828488 -26.8759353129, -65.3127825941 -26.8742523941, -65.3124312426 -26.8729595774, -65.3109681394 -26.8732029589, -65.309824487 -26.8715816611, -65.3086248928 -26.8702135589, -65.3074134545 -26.869261413, -65.3057074973 -26.8679253093, -65.3047428283 -26.8672591415, -65.3037182078 -26.8665089147, -65.3034068544 -26.866276191, -65.3029967445 -26.8659211144, -65.3012329235 -26.864576947, -65.3004245142 -26.8638487267, -65.3001413105 -26.8637637303, -65.2991834141 -26.8630804436, -65.2967043692 -26.8612810235, -65.2928229303 -26.8584703516, -65.2890941325 -26.8556701588, -65.2850232026 -26.8528442113, -65.2836644494 -26.8518835589, -65.2823855734 -26.8508966126, -65.2808266884 -26.8497075177, -65.2792449986 -26.8485156472, -65.2778593038 -26.8475181176, -65.2762767031 -26.8463775139, -65.2732980924 -26.8444043868, -65.2699759771 -26.8420105109, -65.2674207071 -26.840212571, -65.2652519614 -26.8386096698, -65.2610098837 -26.8355889562, -65.2597566364 -26.8349298208, -65.2586000782 -26.8345489493, -65.2570984476 -26.8342198608, -65.255350943 -26.8340932412, -65.2542367662 -26.834174899, -65.2521724802 -26.8345059624, -65.2515407532 -26.8346253355, -65.2504436032 -26.8347896491, -65.2493505477 -26.8349526166, -65.2480130224 -26.8351922971, -65.2466086968 -26.8354410643, -65.2447970131 -26.8357916279, -65.2435499507 -26.8360763123, -65.2422074667 -26.8363569608, -65.2408629954 -26.8366266154, -65.2396127074 -26.8368670536, -65.2384473265 -26.8371337973, -65.2373482814 -26.8373848848, -65.2361224503 -26.8376690177, -65.2350511597 -26.837900279, -65.2340161096 -26.8381087333, -65.232521483 -26.8384154261, -65.231364637 -26.8386448023, -65.2300405272 -26.8389102464, -65.228580108 -26.8391995618, -65.2268699048 -26.8395544035, -65.2253918365 -26.8398470841, -65.2242281512 -26.8400597853, -65.2230666215 -26.8402709012, -65.2221462954 -26.8404541648, -65.2213233336 -26.8406322968, -65.2212176428 -26.8402840852, -65.2209941933 -26.8394163097, -65.2208426989 -26.8386176561, -65.2206527696 -26.8379512157, -65.2204426008 -26.8370492287, -65.2202881749 -26.8365023319, -65.2201444089 -26.8358215385, -65.2199926545 -26.8351433813, -65.2199020664 -26.8347364354, -65.2197773458 -26.8341520153, -65.2196344887 -26.8336521426, -65.2189693643 -26.8337998813, -65.2182458048 -26.8339237141, -65.2174334998 -26.8340949558, -65.2166653767 -26.8342460134, -65.2160087152 -26.8343748372, -65.2153185585 -26.8345029123, -65.2142575816 -26.8347288823, -65.2136031802 -26.8348245615, -65.2127454035 -26.8350019529, -65.2120701363 -26.8351389539, -65.2112645855 -26.8352808536, -65.2104831253 -26.8354240157, -65.2096719899 -26.8356272636, -65.2088965857 -26.8357988984, -65.2082151884 -26.8359589798, -65.2074744188 -26.8361225068, -65.2067160289 -26.8362990697, -65.2059370257 -26.8364736831, -65.2051674475 -26.8366546574, -65.204378835 -26.8368459861, -65.2037648151 -26.8369997696, -65.2029320439 -26.837196839, -65.202276795 -26.8373562683, -65.201417089 -26.8375734835, -65.2006576728 -26.8377609657, -65.2000549776 -26.8379152898, -65.1992246653 -26.8381258085, -65.1985500495 -26.8382828888, -65.198291306 -26.838283176, -65.1981273714 -26.837640906, -65.1979294726 -26.8368174716, -65.1977314155 -26.8359867185, -65.1974890397 -26.8350336444, -65.1973416261 -26.8344243743, -65.1972378779 -26.8339479566, -65.1970328477 -26.8331523387, -65.1968815995 -26.8326092522, -65.1967007262 -26.8318505128, -65.1965433071 -26.8312312037, -65.1963536361 -26.8304622138, -65.1961850957 -26.8297386658, -65.1959974756 -26.8289154105, -65.1958823094 -26.8283435413, -65.1956834347 -26.8275599733, -65.1955368697 -26.8269661995, -65.1953191188 -26.8261012886, -65.195194723 -26.8256291029, -65.1950471284 -26.8249044663, -65.194896601 -26.824332611, -65.1947217818 -26.8235883062, -65.1945418289 -26.8228583863, -65.1948000928 -26.822924493, -65.195583829 -26.8228092978, -65.1963993625 -26.822644298, -65.1972507062 -26.8224926467, -65.197838017 -26.8224091889, -65.1988299542 -26.8222260271, -65.1993150324 -26.822129072, -65.2002043659 -26.8219630274, -65.2007823019 -26.8218601819, -65.201716982 -26.821658628, -65.2023277602 -26.8215440696, -65.2031824906 -26.8213699316, -65.2035829948 -26.821271875, -65.2044971423 -26.8210916204, -65.2051600432 -26.8209544156, -65.2060601235 -26.8207766638, -65.2066702775 -26.8206319013, -65.2076716538 -26.8204267044, -65.2083238635 -26.820294388, -65.2088197926 -26.8202032857, -65.2098808383 -26.8200168802, -65.2100392047 -26.8205988977, -65.2102061467 -26.8213138183, -65.21036383 -26.8220772657, -65.2104995275 -26.822643111, -65.2111552959 -26.8224896822, -65.2119731363 -26.8222910533, -65.2121448306 -26.8229386487, -65.2123514846 -26.8236719528, -65.2125341267 -26.8243964566, -65.2127262523 -26.8251368548, -65.2129161139 -26.8258924856, -65.2130755188 -26.8264956897, -65.2132313884 -26.8271060545, -65.2134551126 -26.8279739739, -65.2136516884 -26.8286793851, -65.2138245618 -26.829341833, -65.2140086332 -26.8299788209, -65.2141442456 -26.8304282186, -65.2143345769 -26.8311277669, -65.2145846823 -26.831981833, -65.2148064376 -26.832716617, -65.214969788 -26.8333641464, -65.21512436 -26.833864681, -65.2153220394 -26.8345225958, -65.2154742314 -26.8350819161, -65.2156759737 -26.8357899514, -65.2163024646 -26.8356357554, -65.2171321572 -26.835442772, -65.2177837729 -26.8353096692, -65.2185215821 -26.8351236465, -65.2193750222 -26.834894941, -65.2198523938 -26.8347794707, -65.219990006 -26.8346603445, -65.2201760748 -26.8354750001, -65.2203289832 -26.8361052227, -65.2206142309 -26.8372901406, -65.2207623898 -26.8379415628, -65.2209615998 -26.8387294492, -65.2210817946 -26.8393191516, -65.2212581954 -26.8399779691, -65.2213305135 -26.8403200838, -65.2215158868 -26.8404024119, -65.2217272175 -26.8404129551, -65.2218321034 -26.8404090023, -65.2225788257 -26.8402653946, -65.2234145251 -26.8400831488, -65.2241664489 -26.8399071601, -65.2254572056 -26.8396637812, -65.2266588599 -26.8394384924, -65.2276515475 -26.839238554, -65.228651514 -26.8390254602, -65.2296500968 -26.8388349531, -65.2307407449 -26.8386022715, -65.2317603058 -26.8384148926, -65.2329143269 -26.8381502024, -65.2337352861 -26.837989441, -65.2350954856 -26.8377077844, -65.2363554938 -26.8374395349, -65.2375032969 -26.8371805518, -65.2381483036 -26.8370390862, -65.2388594209 -26.8368928104, -65.2399393299 -26.8366783765, -65.2409428907 -26.8364420591, -65.2416989719 -26.8363098547, -65.2431700882 -26.8360114666, -65.2440222623 -26.8358215527, -65.2452001416 -26.8355995008, -65.2466414122 -26.8353126445, -65.2478702954 -26.8350853259, -65.2487631712 -26.8349372478, -65.2500823742 -26.8346895583, -65.2514669865 -26.8344238517, -65.2521938592 -26.8343075715, -65.2533492346 -26.8341191447, -65.2542219841 -26.8339762348, -65.254595308 -26.8339408036, -65.2550341965 -26.8339425368, -65.2556101642 -26.8339203682, -65.25719615 -26.8340856755, -65.2579685181 -26.8341458487, -65.2595846549 -26.8347181372, -65.260839995 -26.8353033285, -65.2630950016 -26.8368401731, -65.2653449769 -26.838394211, -65.267958069 -26.8402564002, -65.2710356255 -26.8425145895, -65.2735223189 -26.8443531458, -65.2760864752 -26.8461238626, -65.2784360707 -26.8477522617, -65.281005416 -26.8496612891, -65.2830327296 -26.8512249151, -65.2855503208 -26.8530439715, -65.2874503984 -26.8544725317, -65.2902171085 -26.856435676, -65.2927299039 -26.8582210992, -65.2948634507 -26.8598650822, -65.2962663131 -26.8608739138, -65.2973465731 -26.8616494587, -65.2986522458 -26.8626270842, -65.2992390994 -26.8629012546, -65.2996423474 -26.8629547982, -65.2998918674 -26.8629689716, -65.3002886497 -26.8628930701, -65.300464791 -26.862943205, -65.3006061903 -26.8630464832, -65.3006739264 -26.8632092539, -65.300724228 -26.8634290067, -65.3007738412 -26.8637239972, -65.3009182779 -26.8641085136, -65.3012186642 -26.8644330543, -65.3016696713 -26.8647795037, -65.3025947093 -26.8654810623, -65.3032139638 -26.8659270134, -65.3033621055 -26.8661019248, -65.3035238341 -26.8663166946, -65.3036087708 -26.8663770705, -65.3037928168 -26.8664985578, -65.3045687379 -26.8670721457, -65.3056312524 -26.8678206197, -65.3066860109 -26.8686177497, -65.3075472828 -26.8693366985, -65.3084084812 -26.8699929653, -65.3087273333 -26.870218942, -65.3098563566 -26.8715050786, -65.3103150663 -26.8721613611, -65.3107121028 -26.8727175354, -65.3110006694 -26.873131262, -65.3123924303 -26.8729335749, -65.3127261421 -26.8740701226, -65.313272346 -26.8761872128, -65.3135112899 -26.8769851527, -65.3138115498 -26.8781413211, -65.312658996 -26.8783712933, -65.3108879825 -26.8787488604, -65.3094368504 -26.8790143482)",
            "linea": "El Provincial"
        }

    """

    def handle(self, *args, **options):
        stats = {"lineas": 0, "recorridos": 0}
        tucuman = Ciudad.objects.get(slug="san-miguel-de-tucuman")

        with open("/path/to/json/file.json") as fixture:
            recorridos = json.loads(fixture.read())

        for recorrido in recorridos:
            try:
                linea = Linea.objects.get(
                    nombre=recorrido["linea"], ciudad=tucuman)
            except Linea.DoesNotExist:
                print("Creando linea '{0}'...".format(recorrido["linea"]))
                linea = Linea(nombre=recorrido["linea"])
                linea.save()
                tucuman.lineas.add(linea)
                stats["lineas"] += 1

            print("Creando recorrido '{0}' de linea '{1}'...".format(
                recorrido["nombre"], recorrido["linea"]))
            try:
                Recorrido.objects.get(
                    nombre=recorrido["nombre"],
                    linea=linea,
                    ciudad=tucuman
                )
                continue
            except Recorrido.DoesNotExist:
                recorrido = Recorrido(
                    nombre=recorrido["nombre"],
                    linea=linea,
                    ruta=recorrido["wkt"],
                    inicio=recorrido["inicio"],
                    fin=recorrido["fin"],
                    color_polilinea=recorrido["color"]
                )
                recorrido.save()
                tucuman.recorridos.add(recorrido)
                stats["recorridos"] += 1

        print(stats)
