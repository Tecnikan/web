{% extends "contenido.html" %}

{% load comments %}
{% load bootstrap_tags %}

{% block title %}Ciudad de {{ciudad_actual.nombre|title}} - Cualbondi{% endblock %}
{% block meta_description %}Toda la información sobre líneas, ramales, recorridos, paradas, horarios y tarifas de transporte público local que pasa por la ciudad de {{ciudad_actual.nombre|title}}, incluyendo bondis, micros, colectivos, trenes y subtes.{% endblock %}

{% block custom_top_scripts %}
    {% if request.GET.dynamic_map %}
        <script src="http://openlayers.org/api/OpenLayers.js"></script>
        <script src="http://maps.google.com/maps/api/js?v=3.6&amp;sensor=false"></script>
        <link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" type="text/css" />
    {% endif %}
{% endblock %}

{% block bloque_izquierda %}
    <ul class="breadcrumb">
        <li><a href="/">Inicio</a> <span class="divider">&gt;</span></li>
        <li class="active">{{ciudad_actual.nombre}}</li>
    </ul>

    <h1>Ciudad de {{ciudad_actual.nombre}}</h1>

    <div class="well">
        <form method="GET" action="/mapa/{{ciudad_actual.slug}}/" class="form-inline" style="margin: 0px; font-size: 14px;">
            <span style="margin-right: 5px;">Buscar transporte en <strong>{{ciudad_actual.nombre}}</strong> desde</span>
            <input type="text" name="desde" class="input-medium" placeholder="ingrese origen...">
            <span style="margin-left: 5px; margin-right: 5px;">hasta</span>
            <input type="text" name="hasta" class="input-medium" placeholder="ingrese destino...">
            <button type="submit" class="btn btn-primary"><i class="icon-search icon-white"></i> Buscar »</button>
        </form>
    </div>

    {% if imagenes|length > 1 %}
    <div id="ciudad_carousel" class="carousel slide">
        <div class="carousel-inner">
            {% for imagen in imagenes %}
            <div class="item {% if forloop.first %}active{% endif %}">
                <img src="/{{imagen.custom_890x300.url}}" alt="">
                {% if imagen.titulo and imagen.descripcion %}
                <div class="carousel-caption">
                    <h4>{{imagen.titulo}}</h4>
                    <p>{{imagen.descripcion}}</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <a class="left carousel-control" href="#ciudad_carousel" data-slide="prev">‹</a>
        <a class="right carousel-control" href="#ciudad_carousel" data-slide="next">›</a>
    </div>
    {% endif %}

    {% if ciudad_actual.descripcion %}
        <p>{{ciudad_actual.descripcion}}</p>
        <br />
    {% endif %}

    <h3>Area cubierta por transporte público:</h3>
    <div class="thumbnail"><div id="map" style="background:lightblue; height:300px;">{% if not request.GET.dynamic_map %}<img src="/{{ ciudad_img.url }}" alt="" />{% endif %}</div></div>
    <br />

    <h3>Lineas de micro en {{ciudad_actual.nombre}}:</h3>
    <table class="table table-striped table-bordered table-condensed">
        <tbody>
        {% for columna in lineas|dividir_columnas:5 %}
            <tr>
            {% for linea in columna %}
                <td><a href={{linea.slug}}/>Linea {{linea.nombre}}</a></td>
            {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <br />

    {% if tarifas %}
        <h3>Precio del boleto</h3>
        <table class="table table-striped table-bordered table-condensed">
            <thead>
                <th>Tipo de boleto</th>
                <th>Precio</th>
            </thead>
            <tbody>
            {% for tarifa in tarifas %}
                <tr>
                    <td>{{tarifa.tipo}}</td>
                    <td>${{tarifa.precio}}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        <br />
    {% endif %}

    <!--[if (!IE)|(gt IE 7)]-->
        <h3>Dejanos un comentario sobre "{{ciudad_actual.nombre}}"</h3>
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'cualbondi'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Habilita Javascript para ver los comentarios</noscript>
    <!--[endif]-->
{% endblock %}

{% block custom_scripts %}
{{ block.super }}

<script type="text/javascript">
    $(document).ready(function(){
        //CAROUSEL
        $('.carousel').carousel()

        {% if request.GET.dynamic_map %}

        //Proyeccion que se necesita para transformar proyecciones mas adelante
        var proj = new OpenLayers.Projection("EPSG:4326");

        //Creamos el mapa
        var map = new OpenLayers.Map('map', {theme: null});
        var gmap = new OpenLayers.Layer.Google(
            "Google Streets", {numZoomLevels: 20}
        );
        map.addLayers([gmap]);
        map.setCenter(new OpenLayers.LonLat{{ ciudad_actual.centro.coords }}.transform(
            new OpenLayers.Projection("EPSG:4326"),
            map.getProjectionObject()
        ), {{ ciudad_actual.zoom }});

        //Le agregamos una capa para el poligono de la ciudad
        var style = {'strokeWidth': 2, 'strokeColor': '#0033CC', fillColor: "#0066CC", fillOpacity: 0.5}
        var layer_poligono = new OpenLayers.Layer.Vector("Poligono", {styleMap: new OpenLayers.StyleMap(style) });
        map.addLayer(layer_poligono)

        //Insertamos el poligono en la nueva capa
        poligono_ciudad = new OpenLayers.Format.WKT().read("{{ciudad_actual.envolvente}}");

        poligono_ciudad.geometry.transform(proj, map.getProjectionObject())
        layer_poligono.addFeatures([poligono_ciudad]);

        //Acomodar el zoom al poligono
        var extent = new OpenLayers.Bounds();
        extent.extend(poligono_ciudad.geometry.getBounds())
        map.zoomToExtent(extent);

        {% endif %}
    
    });
</script>

{% endblock %}

