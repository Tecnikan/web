{% extends "contenido.html" %}

{% block custom_top_scripts %}
    <script src="http://openlayers.org/api/OpenLayers.js"></script>
    <script src="http://maps.google.com/maps/api/js?v=3.6&amp;sensor=false"></script>
    <link rel="stylesheet" href="http://openlayers.org/dev/theme/default/style.css" type="text/css" />
{% endblock %}

{% block bloque_izquierda %}
    <ul class="breadcrumb">
        <li><a href="/">Inicio</a> <span class="divider">></span></li>
        <li><a href="/{{ciudad_actual.slug}}">{{ciudad_actual.nombre}}</a> <span class="divider">></span></li>
        <li><a href="/{{ciudad_actual.slug}}/{{linea_actual.slug}}">{{linea_actual.nombre}}</a> <span class="divider">></span></li>
        <li class="active">{{recorrido_actual.nombre}} {% if recorrido_actual.inicio and recorrido_actual.fin %}(de {{recorrido_actual.inicio}} a {{recorrido_actual.fin}}){% endif %}</li>
    </ul>

    <h1>Recorrido {{linea_actual.nombre}} {{recorrido_actual.nombre}} de {{ciudad_actual.nombre}}</h1>
    {% if recorrido_actual.inicio and recorrido_actual.fin %}<h3>desde {{recorrido_actual.inicio}} hasta {{recorrido_actual.fin}}</h3>{% endif %}

    <div class="thumbnail"><div id="map" style="background:lightblue; height:300px;"></div></div>
    <br />

    <h3>Dejanos un comentario sobre el recorrido "{{linea_actual.nombre}} {{recorrido_actual.nombre}}"</h3>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'cualbondi'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
{% endblock %}

{% block custom_ready_function %}
    //Proyeccion que se necesita para transformar proyecciones mas adelante
    var proj = new OpenLayers.Projection("EPSG:4326");

    //Creamos el mapa
    map = new OpenLayers.Map("map", {theme: null})
    var gmap = new OpenLayers.Layer.Google(
        "Google Streets", {numZoomLevels: 20}
    );
    map.addLayers([gmap]);
    map.setCenter(new OpenLayers.LonLat{{ ciudad_actual.centro.coords }}.transform(
        new OpenLayers.Projection("EPSG:4326"),
        map.getProjectionObject()
    ), {{ ciudad_actual.zoom }});

    //Le agregamos una capa para el poligono de la ciudad
    var style = {'strokeWidth': 4, 'strokeColor': '#0033CC', fillColor: "#0066CC", fillOpacity: 0.5}
    var layer_recorrido = new OpenLayers.Layer.Vector("Recorrido", {styleMap: new OpenLayers.StyleMap(style) });
    map.addLayer(layer_recorrido)

    //Le agregamos una capa para los Markers de inicio y fin
    var markers = new OpenLayers.Layer.Markers( "Markers" );
    map.addLayer(markers);

    var size = new OpenLayers.Size(20,50);
    var offset = new OpenLayers.Pixel(-(size.w/2), -size.h);
    var iconA = new OpenLayers.Icon('/media/css/openlayers/markerA.png',size,offset);
    var iconB = new OpenLayers.Icon('/media/css/openlayers/markerB.png',size,offset);

    var lonlat_inicio = new OpenLayers.LonLat{{recorrido_actual.ruta|first}};
    var lonlat_fin = new OpenLayers.LonLat{{recorrido_actual.ruta|last}};

    lonlat_inicio = lonlat_inicio.transform(proj, map.getProjectionObject());
    lonlat_fin = lonlat_fin.transform(proj, map.getProjectionObject());

    markers.addMarker(new OpenLayers.Marker(lonlat_inicio, iconA));
    markers.addMarker(new OpenLayers.Marker(lonlat_fin, iconB));

    $.get("/api/recorridos/{{recorrido_actual.id}}/",
        function(data) {
            path_recorrido = new OpenLayers.Format.WKT().read(data.ruta);
            path_recorrido.geometry.transform(proj, map.getProjectionObject())
            layer_recorrido.addFeatures([path_recorrido]);

            //Acomodar el zoom al poligono
            var extent = new OpenLayers.Bounds();
            extent.extend(path_recorrido.geometry.getBounds())
            map.zoomToExtent(extent);
        },
        "json"
    );
{% endblock %}
