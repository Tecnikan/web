{% extends "base.html" %}

{% block navbar %}
    {% include "navbar.html"%}
{% endblock %}

{% block content %}
        <div class="row-fluid">
            <div id="bloque_izquierda" class="span3">
                <div id="sidebar" style="background:white;">

                    <div class="tabbable">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#1" data-toggle="tab">¿Cómo llegar?</a></li>
                            <li><a href="#2" data-toggle="tab">Recorridos</a></li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="1">
                                <form>
                                    <div class="input-prepend">
                                        <span class="add-on"><i class="icon-map-marker"></i>A</span>
                                        <input type="text" size="16" id="inputDesde" class="span10" placeholder="Desde">
                                    </div>
                                    <div class="input-prepend">
                                        <span class="add-on"><i class="icon-map-marker"></i>B</span>
                                        <input type="text" size="16" id="inputHasta" class="span10" placeholder="Hasta">
                                    </div>
                                    <p><small>Ejemplos: 14 y 54 || 14 n568 || Catedral</small></p>
                                    <div class="btn-toolbar">
                                        <div class="btn-group">
                                            <a id="button-origendestino" class="btn" title="Cambiar origen por destino"><i class="icon-refresh"></i></a>
                                            <a id="button-ayuda" class="btn" title="Ayuda"><i class="icon-question-sign"></i></a>
                                        </div>
                                        <div class="btn-group pull-right">
                                            <button id="button-buscarinputs" class="btn btn-primary" type="submit">Buscar</button>
                                        </div>
                                    </div>
                                </form>
                                <!-- 
                                <div align="left" style="padding-top: 5px;">
                                    <iframe src="//www.facebook.com/plugins/like.php?href=https%3A%2F%2Fwww.facebook.com%2Fcualbondi&amp;send=false&amp;layout=button_count&amp;width=450&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font=verdana&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:450px; height:21px;" allowTransparency="true"></iframe>
                                    <br>
                                    <g:plusone></g:plusone>
                                </div>
                                !-->
                            </div>
                            <div class="tab-pane" id="2">
                                <form>
                                    <div class="input-prepend">
                                        <input type="text" size="16" id="inputLinea" class="span10" placeholder="Linea, ramal, recorrido" data-provide="typeahead">
                                        <span class="add-on"><i class="icon-search"></i></span>
                                    </div>
                                    <button class="btn btn-primary" type="submit">Buscar</button>
                                </form>
                            </div>
                        </div>
                        <hr>
                        <div id="sidebarContenido">
                        </div>
                    </div>

                </div>
            </div>
            <div id="bloque_derecha" class="span9">
                <div id="map" style="background:lightblue;">

                </div>
            </div>
        </div>
{% endblock %}

{% block custom_scripts %}
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript" src="/media/js/bootstrap-typeahead-gist2204728.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;libraries=adsense&amp;sensor=false"></script>
<link rel="stylesheet" href="/media/css/openlayers/style.css" type="text/css" />

<script type="text/javascript">

GLOBAL_ci = "{{ ciudad_actual.slug }}"

$(function() {
    // todo esto inicial es para hacer bootstrap 100% height
    $("#sidebar").css("margin-top", "18px")
    $("#sidebar").css("overflow", "auto")
    $("body").css("padding-bottom","0px")
    $(".navbar").css("margin-bottom","0px")
    if ( $(window).width() > 980 ) {
        $("#map").height(($(window).height()-40)+"px")
        $("#sidebar").height(($(window).height()-58)+"px")
        $("body").css("padding-top","40px")
    }
    else {
        $("#map").height(($(window).height()-50)+"px")
        $("#sidebar").height(($(window).height()-58)+"px")
        $("body").css("padding-top","0px")
    }
    if ( $(window).width() < 456 )
        $("#map").css("margin-right", "0px")
    else
        $("#map").css("margin-right", "-20px")

    $(window).bind('resize', function() {
        $("#sidebar").css("margin-top", "18px")
        $("#sidebar").css("overflow", "auto")
        $("body").css("padding-bottom","0px")
        $(".navbar").css("margin-bottom","0px")
        if ( $(window).width() > 980 ) {
            $("#map").height(($(window).height()-40)+"px")
            $("#sidebar").height(($(window).height()-58)+"px")
            $("body").css("padding-top","40px")
            //esto no anda bien

                $("#sidebar").height(($(window).height()-58)+"px")

        }
        else {
            $("#map").height(($(window).height()-50)+"px")
            $("body").css("padding-top","0px")
            //esto no anda bien

                $("#sidebar").height(($(window).height()-68)+"px")

        }
        if ( $(window).width() < 456 )
            $("#map").css("margin-right", "0px")
        else
            $("#map").css("margin-right", "-20px")
    });
    // fin bootstrap 100% height


    // definicion inicial del mapa
    OpenLayers.ImgPath = "/media/css/openlayers/"
    var map = new OpenLayers.Map("map", {theme: null})
    var gmap = new OpenLayers.Layer.Google(
        "Google Streets", {numZoomLevels: 20}
    );
    var osm = new OpenLayers.Layer.OSM();
    map.addLayers([gmap, osm]);
    //var gmap = new OpenLayers.Layer.Google("Google Streets", {visibility: false});
    //map.addLayers([osm, gmap]);
    //map.addControl(new OpenLayers.Control.LayerSwitcher());
    map.setCenter(new OpenLayers.LonLat{{ ciudad_actual.centro.coords }}.transform(
        new OpenLayers.Projection("EPSG:4326"),
        map.getProjectionObject()
    ), {{ ciudad_actual.zoom }});

    map.zoomOut() //esto es para que el mapa se redibuje (workaround de redraw)
    //map.setCenter(map.center())

    // estilos de los markers
    var styleMap = new OpenLayers.StyleMap({fillColor: '#1166EE', fillOpacity: 0.2, strokeColor: '#1166EE', strokeOpacity: 0.3, strokeWidth: 2});
    lookup = {
        // nombre:hovering:dragging
        "A:false:false": { externalGraphic: "/media/css/openlayers/markerA.png", graphicWidth: 20, graphicHeight: 34, graphicYOffset: -34, graphicOpacity: 1 },
        "A:true:false" : { externalGraphic: "/media/css/openlayers/markerA-hover.png", graphicWidth: 20, graphicHeight: 34, graphicYOffset: -34, graphicOpacity: 1 },
        "A:false:true" : { externalGraphic: "/media/css/openlayers/markerA-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
        "A:true:true"  : { externalGraphic: "/media/css/openlayers/markerA-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
        "B:false:false": { externalGraphic: "/media/css/openlayers/markerB.png", graphicWidth: 20, graphicHeight: 34, graphicYOffset: -34, graphicOpacity: 1 },
        "B:true:false" : { externalGraphic: "/media/css/openlayers/markerB-hover.png", graphicWidth: 20, graphicHeight: 34, graphicYOffset: -34, graphicOpacity: 1 },
        "B:false:true" : { externalGraphic: "/media/css/openlayers/markerB-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
        "B:true:true"  : { externalGraphic: "/media/css/openlayers/markerB-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
    }
    styleMap.addUniqueValueRules("default", "tipo", lookup);

    // creacion de las diferentes capas
    var markers = new OpenLayers.Layer.Vector( "Markers", {
        styleMap: styleMap
        //,renderers: ["SVG2", "VML", "Canvas"] // allow render while panning when possible
    });
    var recorridos = new OpenLayers.Layer.Vector( "Recorridos", {styleMap: new OpenLayers.StyleMap({strokeWidth: 5})});
    map.addLayer(recorridos)
    map.addLayer(markers)

    // proyeccion que se necesita para transformar proyecciones mas adelante
    var proj = new OpenLayers.Projection("EPSG:4326");

    // clase Marker (para manejar el markerA y marerB mas facil)
    function Marker(layer, id) {
        this.listo  = false
        this.point  = null
        this.layer  = layer
        this.id     = id
        this.centro = null
        this.confirmado = false
    }
    Marker.prototype.setPoint = function(point) {
        // setea el punto con latlng y lo pone en el mapa
        // point = new OpenLayers.Geometry.Point(lon, lat);
        if (this.listo) {
            this.layer.removeFeatures(this.point)
        }
        
        this.centro = point
        this.point = new OpenLayers.Feature.Vector(
            new OpenLayers.Geometry.Collection(
                [
                OpenLayers.Geometry.Polygon.createRegularPolygon(point, 600, 20, 0),
                point
                ]
            ),
            {tipo:this.id+":false:false"}
        )
        this.layer.addFeatures([this.point])
        this.listo = true
        this.layer.map.moveTo(this.point)
        this.layer.drawFeature(this.point)
    }

    // dos objetos de la clase marker
    var markerA = new Marker(markers, "A")
    var markerB = new Marker(markers, "B")

    // manejo de clicks en el mapa
    //      creacion de los markers A y B
    //      busqueda por click en el mapa
    var clickHandler = new OpenLayers.Handler.Click(
        { 'map': map },
        {
            'click': function(evt) {
                var lonlat = map.getLonLatFromViewPortPx(evt.xy);
                point = new OpenLayers.Geometry.Point(lonlat.lon, lonlat.lat);
                if ( !markerA.listo ) {
                    markerA.setPoint(point)
                    markerA.confirmado = true
                }
                else
                    if ( !markerB.listo ) {
                        markerB.setPoint(point)
                        markerB.confirmado = true
                        clickHandler.deactivate();
                        pagina = 1
                        buscarporclick(markerA.centro, markerB.centro)
                    }
            }
        }
    );

    // manejo del drag de los markers
    //      cambio de imagenes al draggear y onhover
    //      busqueda por ondrag
    dragControl = new OpenLayers.Control.DragFeature(
        markers,
        {
            onComplete: function(feature, pixel) {
                t = feature.attributes.tipo.split(":")
                feature.attributes.tipo=t[0]+":true:false"
                markers.redraw()
                if ( feature == markerA.punto ) markerA.confirmado = true
                if ( feature == markerB.punto ) markerB.confirmado = true
                pagina = 1
                buscarporclick(markerA.centro, markerB.centro)
            },
            onEnter: function(feature, pixel) {
                t = feature.attributes.tipo.split(":")
                feature.attributes.tipo=t[0]+":true:false"
                markers.redraw()
            },
            onLeave: function(feature, pixel) {
                t = feature.attributes.tipo.split(":")
                feature.attributes.tipo=t[0]+":false:false"
                markers.redraw()
            },
            onStart: function(feature, pixel) {
                t = feature.attributes.tipo.split(":")
                feature.attributes.tipo=t[0]+":true:true"
                markers.redraw()
            }
        }
    )
    map.addControl(dragControl)

    // activar el click y drag handlers
    clickHandler.activate()
    dragControl.activate()

    // buscador de lineas por sugerencia al tipear
    $('#inputLinea').attr("autocomplete","off")

    $('#inputLinea').keyup(function () {
        $("#ajaxLoader").tmpl().appendTo($("#sidebarContenido").empty())
        if ( ajaxInputLinea ) ajaxInputLinea.abort()
        pagina = 1
        inputLinea()
    })

    function inputLinea() {
        buscar = false
        ajaxInputLinea = $.ajax({
            url: "/api/recorridos/?c="+GLOBAL_ci+"&q="+$('#inputLinea').val()+"&p="+pagina,
            success: mostrarResultados
        })
    }

    var adUnitDiv = document.createElement('div');
    var adUnitOptions = {
        format: google.maps.adsense.AdFormat.HALF_BANNER,
        position: google.maps.ControlPosition.TOP,
        map: map.baseLayer.mapObject,
        visible: true,
        publisherId: 'ca-pub-1193419141108967'
    }
    adUnit = new google.maps.adsense.AdUnit(adUnitDiv, adUnitOptions);

    // variables "globales"
    var resultados = new Object()
    var poly       = null
    var polyhover  = null
    var pagina     = 1
    var ajaxInputLinea = false
    var buscar     = true //false si busca de A a B, true si busca por nombre de recorrido (es para llamar la funcion correcta al paginar)

    // aca arrancan las funciones de cualbondi que pueden llamarse desde el html
    // namespace de cualbondi que se ve desde afuera por mas que minifiquemos
    $.cb = new Object()

    // handler para mostrar resultados, usa el template de listado de results
    $.cb.mostrar_resultado = function(id) {
        if ( typeof(id)==='undefined' )
            id = $("#sidebarContenido li:first").attr("id").slice(3)
        $("#sidebarContenido li").removeClass("active")
        $("#res"+id).addClass("active")
        recorridos.removeAllFeatures()
        poly = new OpenLayers.Format.WKT().read(resultados[id].ruta_corta);
        poly.geometry.transform(proj, map.getProjectionObject())
        recorridos.addFeatures([poly]);
    }

    function buscar_por_inputs() {
        $("#ajaxLoader").tmpl().appendTo($("#sidebarContenido").empty())
        var data1 = null
        var data2 = null
        // muestra los resultados de la busqueda como sugerencia
        function mostrarResultadoCatastro(data, id) {
            data.id = id
            data = $.map(data, function(item, i){item.id = id; item.domId = Math.floor(Math.random()*10000);return item});
            if ( id == 1 ) data1=data
            else data2=data
            if ( data1 !== null && data2 !== null ) {
                $("#listSuggest").tmpl([{ data1: data1, data2: data2 }]).appendTo($("#sidebarContenido").empty())
            }
        }
        $.ajax({
            url: "/api/catastro/?query="+$("#inputDesde").val(),
            success: function (data) {
                mostrarResultadoCatastro(data, 1)
            }
        })
        $.ajax({
            url: "/api/catastro/?query="+$("#inputHasta").val(),
            success: function (data) {
                mostrarResultadoCatastro(data, 2)
            }
        })
    }

    // mueve el markerA o B a el punto seleccionado
    $.cb.marcarPunto = function(pointWKT, id, domId) {
        // pointWKT es 'POINT(12.234 56.789)'
        // id es 1 para origen(markerA) y 2 para destino(markerB)
        var point = new OpenLayers.Format.WKT().read(pointWKT).geometry
        point.transform(proj, map.getProjectionObject())
        point = new OpenLayers.Geometry.Point(point.x, point.y);
        if ( id == 1 )
            markerA.setPoint(point)
        else if ( id == 2 )
            markerB.setPoint(point)
        map.panTo(new OpenLayers.LonLat(point.x, point.y))
        $("#sug" + domId).siblings().removeClass("active")
        $("#sug" + domId).addClass("active")
    }

    // busca una vez que se eligieron las sugerencias
    $.cb.seleccionarSugerencias = function() {
        markerA.confirmado = true
        markerB.confirmado = true
        if ( markerA.listo && markerB.listo ) {
            pagina = 1
            buscarporclick(markerA.centro, markerB.centro)
        }
    }

    // pasa a la siguiente pagina
    // n = -1: pagina anterior
    //      x: pagina x
    //      0: pagina siguiente
    $.cb.pagina = function(n) {
        if ( n < 0 )
            pagina = ( pagina > 1 ) ? pagina - 1 : 1;
        else if ( n == 0 )
            pagina+=1;
        else if ( n > 0)
            pagina = n;

        if ( buscar )
            buscarporclick(markerA.centro, markerB.centro)
        else
            inputLinea()
    }

    // envia peticion al server para buscar por latlng
    function buscarporclick(lla, llb) {
        buscar     = true
        $("#ajaxLoader").tmpl().appendTo($("#sidebarContenido").empty())
        lla = lla.transform(map.getProjectionObject(), proj)
        llb = llb.transform(map.getProjectionObject(), proj)
        $.get(
            "/api/recorridos/",
            {
                origen: lla.x+","+lla.y,
                destino: llb.x+","+llb.y,
                radio_origen: "500",
                radio_destino: "500",
                c: GLOBAL_ci,
                p: pagina
            },
            mostrarResultados
        );
        lla = lla.transform(proj, map.getProjectionObject())
        llb = llb.transform(proj, map.getProjectionObject())
    }

    // muestra los resultados devueltos por el server usando un template
    function mostrarResultados(data){
        res = data['resultados']
        if ( res.length === 0 )
            if ( pagina == 1 )
                $("#vacioTempl").tmpl().appendTo($("#sidebarContenido").empty());
            else
                pagina -= 1
        else {
            resultados = new Object()
            $.each(res, function(key, value) {
                resultados[value.id] = value
            });
            $("#listTempl").tmpl( [{ data: data }] ).appendTo($("#sidebarContenido").empty());
            $("[id^=res]").each( function(i) {
                $(this).children().bind("click", function(e) {
                    id = $(this).attr("id")
                    $.cb.mostrar_resultado(id)
                    e.preventDefault()
                })
                $(this).children().bind("mouseenter", function(e) {
                    id = $(this).attr("id")
                    if (polyhover !== null) recorridos.removeFeatures([polyhover])
                    polyhover = new OpenLayers.Format.WKT().read(resultados[id].ruta_corta);
                    polyhover.geometry.transform(proj, map.getProjectionObject())
                    recorridos.addFeatures([polyhover])
                    recorridos.drawFeature(polyhover, { fillOpacity: 0.2, strokeWidth: 5 })
                })
                $(this).children().bind("mouseleave", function(e) {
                    if (polyhover !== null) recorridos.removeFeatures([polyhover])
                })
            })
            $.cb.mostrar_resultado()
        }
    }

    // bind eventos click
    $("#button-ayuda").bind("click", function(e) {
        $("#ayudaTempl").tmpl().appendTo($("#sidebarContenido").empty());
        e.preventDefault()
    })
    
    $("#button-origendestino").bind("click", function(e) {
        desde = $("#inputDesde").val()
        hasta = $("#inputHasta").val()
        if ( $.trim(desde) != '' && $.trim(hasta) != '' ) {
            $("#inputDesde").val(hasta)
            $("#inputHasta").val(desde)
        }
        if ( markerA.confirmado && markerB.confirmado ) {
            ma = new OpenLayers.Geometry.Point(markerA.centro.x, markerA.centro.y)
            mb = new OpenLayers.Geometry.Point(markerB.centro.x, markerB.centro.y)
            markerA.setPoint(mb)
            markerB.setPoint(ma)
            // buscar sobre los markers
            buscarporclick(markerA.centro, markerB.centro)
        }
        else {
            // buscar sobre los textbox
            buscar_por_inputs()
        }
        e.preventDefault()
    })

    function invalidarMarkers() {
        markerA.confirmado = false
        markerB.confirmado = false
    }
    $("#inputDesde").bind("change", invalidarMarkers)
    $("#inputHasta").bind("change", invalidarMarkers)

    $("#button-buscarinputs").bind("click", function(e) {
        buscar_por_inputs()
        e.preventDefault()
    })

})
</script>

<script id="ajaxLoader" type="text/x-jquery-tmpl">
<center>
    <img src="/media/img/ajax-loader.gif" />
</center>
</script>

<script id="listTempl" type="text/x-jquery-tmpl">
<div><small>Página ${data['p']}</small><small class="pull-right">${data['cant']} resultados</small></div>
<div>
<ul class="nav nav-pills nav-stacked">
    {% templatetag openvariable %}tmpl(data['resultados']) "#itemTempl"{% templatetag closevariable %}
</ul>
{% templatetag openvariable %}tmpl(data) "#paginacionTempl"{% templatetag closevariable %}
</div>
</script>
<script id="itemTempl" type="text/x-jquery-tmpl"> 
    <li id="res${id}">
        <a href="#" id="${id}">
            <strong>${nombre}</strong>
            <br>
            de ${inicio} a ${fin}
            <br>
            a pie: ${long_pata}km
            <br>
            en bondi:${long_bondi}km
        </a>
    </li>
</script>

<script id="paginacionTempl" type="text/x-jquery-tmpl">
    <div class="pagination pagination-centered">
        <ul>
            <li><a href="#" onclick="javascript:$.cb.pagina(-1);return false">«</a></li>
            <li><a href="#" onclick="javascript:$.cb.pagina(1);return false">1</a></li>
            <li class="disabled"><a>...</a></li>
            <li><a href="#" onclick="javascript:$.cb.pagina(${Math.ceil(cant/long_pagina)});return false">${Math.ceil(cant/long_pagina)}</a></li>
            <li><a href="#" onclick="javascript:$.cb.pagina(0);return false">»</a></li>
        </ul>
    </div>
</script>

<script id="listSuggest" type="text/x-jquery-tmpl">
<p>Seleccione la opción correcta</p>
<div class="well sidebar-nav" style="padding-bottom:20px">
    <ul class="nav nav-list">
        <li class="nav-header">Origen:</li>
    </ul>
    <ul id="#sug1" class="nav nav-list">
        {% templatetag openvariable %}tmpl(data1) "#itemSuggest"{% templatetag closevariable %}
    </ul>
    <ul class="nav nav-list">
        <li class="nav-header">Destino:</li>
    </ul>
    <ul id="#sug2" class="nav nav-list">
        {% templatetag openvariable %}tmpl(data2) "#itemSuggest"{% templatetag closevariable %}
    </ul>
    <div>
        &nbsp;
        <button style="margin:5px" class="btn btn-primary pull-right" type="submit" onclick="javascript:$.cb.seleccionarSugerencias();return false">Aceptar</button>
    </div>
</ul>
</script>
<script id="itemSuggest" type="text/x-jquery-tmpl">
    <li id="sug${domId}">
        <a href="#" onclick="javascript:$.cb.marcarPunto('${geom}', ${id}, ${domId});return false">${nombre} <span style="font-size:0.6em; color:#AAA">(${(precision*100).toFixed(2)}%)</span></a>
    </li>
</script>

<script id="ayudaTempl" type="text/x-jquery-tmpl">
   <h3>¿Como busco recorridos?</h3>
   <h4>Campos de búsqueda</h4>
   <p>Escriba directamente en los campos de texto del panel superior. Puede considerar interseccion de calles, calle y número o lugares de interes. Vea los ejemplos debajo de los campos de búsqueda.</p>
   <h4>Click sobre el mapa</h4>
   <p> hacer click directamente sobre el mapa para indicar el Origen y Destino de su búsqueda. Luego puede arrastrar los marcadores A o B para editar su ubicación.</p>
   <h4>Lineas de micro</h4>
   <p>Para buscar un recorrido completo de una linea de colectivo en particular, consulte la sección "Recorridos" aqui arriba.</p>
</script>

<script id="vacioTempl" type="text/x-jquery-tmpl">
   <h3>No se encontraron resultados</h3>
</script>

{% endblock %}

{% block custom_top_scripts %}

{% endblock %}

{% block custom_styles %}

{% endblock %}
