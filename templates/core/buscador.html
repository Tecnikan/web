{% extends "base.html" %}

{% block title %}Cualbondi - Buscador de recorridos de micros en la ciudad de {{ciudad_actual.nombre|title}}{% endblock %}

{% block navbar %}
    <div class="navbar navbar-fixed-top navbar-inverse">
        <div class="navbar-inner">
            <div class="container-fluid">
                {% include "navbar.html"%}
            </div>
        </div>
    </div>
{% endblock %}

{% block custom_styles %}
    <link href="/media/css/buscador.css" rel="stylesheet" type="text/css" />
{% endblock %}

{% block content %}
    <div id="bloque_izquierda">
        <div class="tabbable">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#1" data-toggle="tab">¿Cómo llegar?</a></li>
                <li><a href="#2" data-toggle="tab">Recorridos</a></li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="1">
                    <input type="text" id="inputDesde" class="input-block-level" placeholder="Desde" {% if desde %}value="{{desde}}"{% endif %}>
                    <input type="text" id="inputHasta" class="input-block-level" placeholder="Hasta" {% if hasta %}value="{{hasta}}"{% endif %}>
                    <p><small>Ejemplos: {{ ciudad_actual.sugerencia }}</small></p>
                    <div class="btn-group">
                        <a id="button-origendestino" class="btn" title="Cambiar origen por destino"><i class="icon-refresh"></i></a>
                        <a id="button-ayuda" class="btn" title="Ayuda"><i class="icon-question-sign"></i></a>
                    </div>
                    <button id="button-buscarinputs" class="btn btn-primary pull-right" title="Buscar recorridos" type="submit"><i class="icon-search icon-white"></i> Buscar</button>
                    <div style="clear:both;"></div>
                    <hr>
                    <div id="sidebarResultados"></div>
                </div>
                <div class="tab-pane" id="2">
                    <input type="text" id="inputLinea" class="input-block-level" placeholder="Linea, ramal o recorrido">
                    <button id="button-buscarnombre" class="btn btn-primary pull-right" type="submit"><i class="icon-search icon-white"></i> Buscar</button>
                    <div style="clear:both;"></div>
                    <hr>
                    <div id="sidebarResultadosPorNombre"></div>
                </div>
            </div>
            <div id="sidebarContenido"></div>
        </div>
    </div>
    <div id="bloque_derecha">
        <div id="mapa" class="shadowbox"></div>
    </div>
{% endblock %}

{% block custom_ready_function %}
    $(window).bind('resize', function() {
        check_layout();
    })
    check_layout();
{% endblock %}

{% block custom_scripts %}
<script src="http://openlayers.org/api/OpenLayers.js"></script>
<script type="text/javascript" src="/media/js/jquery.base64.min.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;libraries=adsense&amp;sensor=false"></script>
<link rel="stylesheet" href="/media/css/openlayers/style.css" type="text/css" />

    <script type="text/javascript">
        function check_layout(){
            if ($(window).width() > 980){
                // bootstrap 100% height (similar googlemaps)
                $("#bloque_derecha").height($(window).height()-40+"px");
                $("#bloque_izquierda").height($(window).height()-60+"px");
                $("#bloque_derecha").width($(window).width()-$("#bloque_izquierda").width()-26+"px");
            }else{
                // para tables y celulares, mapa abajo de los resultados
                $("#bloque_derecha").width("100%");
                $("#bloque_izquierda").height("auto");
            }
        }
        GLOBAL_ci = "{{ ciudad_actual.slug }}"

        $(function() {
            // definicion inicial del mapa
            OpenLayers.ImgPath = "/media/css/openlayers/"
            var map = new OpenLayers.Map("mapa", {theme: null})
            var gmap = new OpenLayers.Layer.Google(
                "Google Streets", {numZoomLevels: 20}
            );
            var osm = new OpenLayers.Layer.OSM();
            map.addLayers([gmap, osm]);
            //var gmap = new OpenLayers.Layer.Google("Google Streets", {visibility: false});
            //map.addLayers([osm, gmap]);
            //map.addControl(new OpenLayers.Control.LayerSwitcher());
            map.setCenter(new OpenLayers.LonLat{{ ciudad_actual.centro.coords }}.transform(
                new OpenLayers.Projection("EPSG:4326"),
                map.getProjectionObject()
            ), {{ ciudad_actual.zoom }});

            map.zoomOut() //esto es para que el mapa se redibuje (workaround de redraw)
            //map.setCenter(map.center())

            // estilos de los markers
            var styleMap = new OpenLayers.StyleMap({fillColor: '#1166EE', fillOpacity: 0.2, strokeColor: '#1166EE', strokeOpacity: 0.3, strokeWidth: 2});
            lookup = {
                // nombre:hovering:dragging
                "A:false:false": { externalGraphic: "/media/css/openlayers/markerA.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -50, graphicOpacity: 1 },
                "A:true:false" : { externalGraphic: "/media/css/openlayers/markerA-hover.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -50, graphicOpacity: 1 },
                "A:false:true" : { externalGraphic: "/media/css/openlayers/markerA-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
                "A:true:true"  : { externalGraphic: "/media/css/openlayers/markerA-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
                "B:false:false": { externalGraphic: "/media/css/openlayers/markerB.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -50, graphicOpacity: 1 },
                "B:true:false" : { externalGraphic: "/media/css/openlayers/markerB-hover.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -50, graphicOpacity: 1 },
                "B:false:true" : { externalGraphic: "/media/css/openlayers/markerB-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 },
                "B:true:true"  : { externalGraphic: "/media/css/openlayers/markerB-drag.png", graphicWidth: 20, graphicHeight: 50, graphicYOffset: -41, graphicOpacity: 1 }
            }
            styleMap.addUniqueValueRules("default", "tipo", lookup);

            // creacion de las diferentes capas
            var markers = new OpenLayers.Layer.Vector( "Markers", {
                styleMap: styleMap
                //,renderers: ["SVG2", "VML", "Canvas"] // allow render while panning when possible
            });
            var recorridos = new OpenLayers.Layer.Vector( "Recorridos", {styleMap: new OpenLayers.StyleMap({strokeWidth: 5})});
            map.addLayer(recorridos)
            map.addLayer(markers)

            // proyeccion que se necesita para transformar proyecciones mas adelante
            var proj = new OpenLayers.Projection("EPSG:4326");

            // clase Marker (para manejar el markerA y marerB mas facil)
            function Marker(layer, id, visible) {
                if (typeof(visible)=='undefined') this.visible = true
                else this.visible = visible
                this.listo  = false
                this.point  = null
                this.layer  = layer
                this.id     = id
                this.centro = null
                this.confirmado = false
            }
            Marker.prototype.setPoint = function(point) {
                // setea el punto con latlng y lo pone en el mapa
                // point = new OpenLayers.Geometry.Point(lon, lat);
                if (this.visible)
                    if (this.listo)
                        this.layer.removeFeatures(this.point)

                this.centro = point
                this.point = new OpenLayers.Feature.Vector(
                    new OpenLayers.Geometry.Collection(
                        [
                        OpenLayers.Geometry.Polygon.createRegularPolygon(point, 600, 20, 0),
                        point
                        ]
                    ),
                    {tipo:this.id+":false:false"}
                )

                if (this.visible) {
                    this.layer.addFeatures([this.point])
                    this.listo = true
                    this.layer.map.moveTo(this.point)
                    this.layer.drawFeature(this.point)
                }
            }

            // dos objetos de la clase marker
            var markerA = new Marker(markers, "A")
            var markerB = new Marker(markers, "B")
            var markerAaux = new Marker(markers, "A", false)
            var markerBaux = new Marker(markers, "B", false)

            // manejo de clicks en el mapa
            //      creacion de los markers A y B
            //      busqueda por click en el mapa
            var clickHandler = new OpenLayers.Handler.Click(
                { 'map': map },
                {
                    'click': function(evt) {
                        var lonlat = map.getLonLatFromViewPortPx(evt.xy);
                        point = new OpenLayers.Geometry.Point(lonlat.lon, lonlat.lat);
                        if ( !markerA.listo ) {
                            markerA.setPoint(point)
                            markerAaux.setPoint(point)
                            markerA.confirmado = true
                            piwikLog("/click/mapa/marker/A")
                        }
                        else
                            if ( !markerB.listo ) {
                                markerB.setPoint(point)
                                markerBaux.setPoint(point)
                                markerB.confirmado = true
                                piwikLog("/click/mapa/marker/B")
                                clickHandler.deactivate();
                                pagina_input = 1
                                buscarporclick(markerA.centro, markerB.centro)
                            }
                    }
                }
            );

            // manejo del drag de los markers
            //      cambio de imagenes al draggear y onhover
            //      busqueda por ondrag
            dragControl = new OpenLayers.Control.DragFeature(
                markers,
                {
                    onComplete: function(feature, pixel) {
                        t = feature.attributes.tipo.split(":")
                        feature.attributes.tipo=t[0]+":true:false"
                        markers.redraw()
                        if ( feature == markerA.point ) {
                            markerA.confirmado = true
                            markerAaux.setPoint(markerA.centro)
                            markerBaux.setPoint(markerB.centro)
                            piwikLog("/click/mapa/drag/A")
                        }
                        if ( feature == markerB.point ) {
                            markerB.confirmado = true
                            markerAaux.setPoint(markerA.centro)
                            markerBaux.setPoint(markerB.centro)
                            piwikLog("/click/mapa/drag/B")
                        }
                        if (markerA.centro !== null && markerB.centro !== null) {
                            $('a[data-toggle="tab"]').first().tab('show')
                            pagina_input = 1
                            buscarporclick(markerA.centro, markerB.centro)
                        }
                    },
                    onEnter: function(feature, pixel) {
                        t = feature.attributes.tipo.split(":")
                        feature.attributes.tipo=t[0]+":true:false"
                        markers.redraw()
                    },
                    onLeave: function(feature, pixel) {
                        t = feature.attributes.tipo.split(":")
                        feature.attributes.tipo=t[0]+":false:false"
                        markers.redraw()
                    },
                    onStart: function(feature, pixel) {
                        t = feature.attributes.tipo.split(":")
                        feature.attributes.tipo=t[0]+":true:true"
                        markers.redraw()
                    }
                }
            )
            map.addControl(dragControl)

            // activar el click y drag handlers
            clickHandler.activate()
            dragControl.activate()

            var adUnitDiv = document.createElement('div');
            var adUnitOptions = {
                format: google.maps.adsense.AdFormat.HALF_BANNER,
                position: google.maps.ControlPosition.TOP,
                map: map.baseLayer.mapObject,
                visible: true,
                publisherId: 'ca-pub-1193419141108967'
            }
            adUnit = new google.maps.adsense.AdUnit(adUnitDiv, adUnitOptions);

            // variables "globales"
            var resultados = new Object()
            resultados[true] = new Object()
            resultados[false] = new Object()
            var polylinea  = new Array()
            var polyhover  = new Array()
            var pagina_input     = 1
            var pagina_nombre    = 1
            var ajaxInputLinea = false
            var buscar     = true //false si busca de A a B, true si busca por nombre de recorrido (es para llamar la funcion correcta al paginar)

            // handler para mostrar resultados, usa el template de listado de results
            function mostrar_resultado(id, porNombre) {
                try {
                    if ( typeof(id)==='undefined' )
                        if (porNombre)
                            id = $("#sidebarResultadosPorNombre li:first").attr("id").slice(3)
                        else
                            id = $("#sidebarResultados li:first").attr("id").slice(3)
                }
                catch (err) {
                    console.log(err)
                    return 1
                }

                if (porNombre) {
                    $("#sidebarResultadosPorNombre li").removeClass("active")
                    $("#sidebarResultadosPorNombre #res"+id).addClass("active")
                }
                else {
                    $("#sidebarResultados li").removeClass("active")
                    $("#sidebarResultados #res"+id).addClass("active")
                }
                recorridos.removeAllFeatures()

                var polylinea = new Array()
                $.each(resultados[porNombre][id], function(key, value) {
                    var poly = new OpenLayers.Format.WKT().read($.base64.decode(value.ruta_corta));
                    poly.geometry.transform(proj, map.getProjectionObject())
                    var style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
                    style.strokeOpacity = 0.8;
                    style.strokeWidth   = 5;
                    style.strokeColor   = value.color_polilinea ? value.color_polilinea : "#000000";
                    poly.style          = style;
                    polylinea.push(poly);
                });
                recorridos.addFeatures(polylinea);
                if (porNombre) {
                    markerA.setPoint(polylinea[0].geometry.getVertices()[0]);
                    markerB.setPoint(polylinea[polylinea.length-1].geometry.getVertices()[polylinea[polylinea.length-1].geometry.getVertices().length-1]);
                }
                else {
                    markerA.setPoint(markerAaux.centro);
                    markerB.setPoint(markerBaux.centro);
                }
                map.panTo(recorridos.getDataExtent().getCenterLonLat());
                map.zoomTo(map.getZoomForExtent(recorridos.getDataExtent())-1);
            }

            function buscar_por_inputs() {
                recorridos.removeAllFeatures()
                $("#ajaxLoader").tmpl().appendTo($("#sidebarResultados").empty())
                var data1 = null
                var data2 = null
                // muestra los resultados de la busqueda como sugerencia
                function mostrarResultadoCatastro(data, id) {
                    data.id = id
                    data = $.map(data, function(item, i){item.id = id; item.domId = Math.floor(Math.random()*10000);return item});
                    if ( id == 1 ) data1=data
                    else data2=data
                    if ( data1 !== null && data2 !== null ) {
                        piwikTracker.trackSiteSearch( $("#inputDesde").val(), "Desde", data1.length )
                        piwikTracker.trackSiteSearch( $("#inputHasta").val(), "Hasta", data2.length )
                        $("#listSuggest").tmpl([{ data1: data1, data2: data2 }]).appendTo($("#sidebarResultados").empty())
                        bindearEventos(false);
                    }
                }
                $.ajax({
                    url: "/api/catastro/?query="+$("#inputDesde").val()+"&ciudad="+GLOBAL_ci,
                    success: function (data) {
                        mostrarResultadoCatastro(data, 1)
                    }
                })
                $.ajax({
                    url: "/api/catastro/?query="+$("#inputHasta").val()+"&ciudad="+GLOBAL_ci,
                    success: function (data) {
                        mostrarResultadoCatastro(data, 2)
                    }
                })
            }

            // mueve el markerA o B a el punto seleccionado
            function marcarPunto(pointWKT, id, domId) {
                // pointWKT es 'POINT(12.234 56.789)'
                // id es 1 para origen(markerA) y 2 para destino(markerB)
                var point = new OpenLayers.Format.WKT().read(pointWKT).geometry
                point.transform(proj, map.getProjectionObject())
                point = new OpenLayers.Geometry.Point(point.x, point.y);
                if ( id == 1 ) {
                    markerA.setPoint(point)
                    markerAaux.setPoint(point)
                }
                else if ( id == 2 ) {
                    markerB.setPoint(point)
                    markerBaux.setPoint(point)
                }
                map.panTo(new OpenLayers.LonLat(point.x, point.y))
                $("#sug" + domId).siblings().removeClass("active")
                $("#sug" + domId).addClass("active")
            }

            // busca una vez que se eligieron las sugerencias
            function seleccionarSugerencias() {
                markerA.confirmado = true
                markerB.confirmado = true
                if ( markerA.listo && markerB.listo ) {
                    pagina_input = 1
                    buscarporclick(markerA.centro, markerB.centro)
                }
            }

            // busca por transbordo
            function buscarTransbordo() {
                markerA.confirmado = true
                markerB.confirmado = true
                if ( markerA.listo && markerB.listo ) {
                    pagina_input = 1
                    buscarporclick(markerA.centro, markerB.centro, 'true')
                }
            }

            // pasa a la siguiente pagina
            // n = -1: pagina anterior
            //      x: pagina x
            //      0: pagina siguiente
            function pasarPagina(n, combinar, porNombre) {
                n = parseInt(n);
                if (porNombre) {
                    if ( n < 0 )
                        pagina_nombre = ( pagina_nombre > 1 ) ? pagina_nombre - 1 : 1;
                    else if ( n == 0 )
                        pagina_nombre+=1;
                    else if ( n > 0)
                        pagina_nombre = n;
                }
                else {
                    if ( n < 0 )
                        pagina_input = ( pagina_input > 1 ) ? pagina_input - 1 : 1;
                    else if ( n == 0 )
                        pagina_input+=1;
                    else if ( n > 0)
                        pagina_input = n;                
                }

                if ( !porNombre )
                    buscarporclick(markerA.centro, markerB.centro, combinar);
                else
                    inputLinea();
            }

            // envia peticion al server para buscar por latlng
            function buscarporclick(lla, llb, combinar) {
                if ( typeof(combinar) === 'undefined' ) combinar = 'false';
                buscar     = true
                recorridos.removeAllFeatures()
                $("#ajaxLoader").tmpl().appendTo($("#sidebarResultados").empty())
                lla = lla.transform(map.getProjectionObject(), proj)
                llb = llb.transform(map.getProjectionObject(), proj)
                $.get(
                    "/api/recorridos/",
                    {
                        origen: lla.x+","+lla.y,
                        destino: llb.x+","+llb.y,
                        radio_origen: "500",
                        radio_destino: "500",
                        c: GLOBAL_ci,
                        p: pagina_input,
                        combinar: combinar
                    },
                    function (data){
                        mostrarResultados(data, combinar);
                    }
                );
                lla = lla.transform(proj, map.getProjectionObject())
                llb = llb.transform(proj, map.getProjectionObject())
            }

            // muestra los resultados devueltos por el server usando un template
            function mostrarResultados(data, combinar, porNombre){
                if ( typeof(porNombre)==='undefined' ) porNombre = false
                if ( typeof(combinar) ==='undefined' ) combinar  = 'false'

                res = data['resultados']
                if ( res.length === 0 )
                    if ( (porNombre && pagina_nombre == 1) || (!porNombre && pagina_input == 1) ) {
                        if (porNombre)
                            $("#vacioTempl").tmpl().appendTo($("#sidebarResultadosPorNombre").empty());
                        else
                            if (combinar == 'true')
                                $("#vacio2Templ").tmpl().appendTo($("#sidebarResultados").empty());
                            else
                                $("#vacio1Templ").tmpl().appendTo($("#sidebarResultados").empty());
                        bindearEventos(porNombre);
                    }
                    else {
                        if (porNombre)
                            pagina_nombre -= 1
                        else
                            pagina_input -= 1
                    }
                else {
                    resultados[porNombre] = new Object()
                    $.each(res, function(key, value) {
                        resultados[porNombre][value.id] = value.itinerario
                    });

                    data['combinar'] = combinar;
                    data['porNombre'] = porNombre;
                    if (porNombre)
                        divResultados = $("#sidebarResultadosPorNombre")
                    else
                        divResultados = $("#sidebarResultados")

                    // calcular lista de paginas a mostrar
                    data['cant_paginas'] = Math.ceil(data['cant']/data['long_pagina']);
                    data['page_list'] = new Array();
                    for (var i=0; i<data['cant_paginas']; i++){
                        data['page_list'].push(i+1);
                    }
                    var index = data['page_list'].indexOf(data['p']);
                    var desde = index - 3 > 0 ? index - 3 : 0;
                    var hasta = index + 3 < data['cant_paginas'] ? index + 3 : data['cant_paginas'];
                    data['page_list'] = data['page_list'].slice(desde, hasta);

                    $("#listTempl").tmpl( [{ data: data }] ).appendTo(divResultados.empty());
                    bindearEventos(porNombre);
                    divResultados.find("[id^=res]").each( function(i) {
                        $(this).children().bind("click", function(e) {
                            id = $(this).attr("id")
                            //console.log(this)
                            //console.log(porNombre)
                            mostrar_resultado(id, porNombre)
                            e.preventDefault()
                            if (porNombre)
                                piwikLog("/click/resultado/porNombre/"+$.map(resultados[porNombre][id], function(e){ e.name } ).join("+"))
                            else
                                piwikLog("/click/resultado/busqueda/"+$.map(resultados[porNombre][id], function(e){ e.name } ).join("+"))
                        })
                        $(this).children().bind("mouseenter", function(e) {
                            id = $(this).attr("id")
                            recorridos.removeFeatures(polyhover)
                            polyhover = new Array();
                            $.each(resultados[porNombre][id], function(key, value) {
                                var poly = new OpenLayers.Format.WKT().read($.base64.decode(value.ruta_corta))
                                poly.geometry.transform(proj, map.getProjectionObject())
                                var style = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
                                style.strokeOpacity = 0.5
                                style.strokeWidth   = 5
                                style.strokeColor   = value.color_polilinea ? value.color_polilinea : "#000000"
                                poly.style          = style
                                polyhover.push(poly);
                            });
                            recorridos.addFeatures(polyhover)
                        })
                        $(this).children().bind("mouseleave", function(e) {
                            recorridos.removeFeatures(polyhover)
                        })
                    })
                    mostrar_resultado(undefined, porNombre)
                }
            }

            // bind eventos click partes estaticas de la pagina (bind unico)
            
            // buscador de lineas por sugerencia al tipear
            $('#inputLinea').attr("autocomplete","off")

            $('#inputLinea').keypress(function (e) {
                if (e.which == 13){
                    e.preventDefault();
                    piwikLog("/click/buscarNombre/enter/"+$("#inputLinea").val())
                    buscar_por_nombre()                
                }
            })
            
            $("#button-buscarnombre").bind("click", function(e) {
                e.preventDefault();
                piwikLog("/click/buscarNombre/button/"+$("#inputLinea").val())
                buscar_por_nombre();
            })           
            
            function buscar_por_nombre() {
                recorridos.removeAllFeatures()
                $("#ajaxLoader").tmpl().appendTo($("#sidebarResultadosPorNombre").empty())
                if ( ajaxInputLinea ) ajaxInputLinea.abort()
                pagina_nombre = 1
                inputLinea()  
            }

            function inputLinea() {
                buscar = false
                ajaxInputLinea = $.ajax({
                    url: "/api/recorridos/?c="+GLOBAL_ci+"&q="+$('#inputLinea').val()+"&p="+pagina_nombre,
                    success: function(data) {mostrarResultados(data, false, true)}
                })
            }
            
            $("#button-ayuda").bind("click", function(e) {
                e.preventDefault()
                $("#ayudaTempl").tmpl().appendTo($("#sidebarResultados").empty());
                piwikLog("/click/botonera/ayuda")
            })

            function invalidarMarkers() {
                markerA.confirmado = false
                markerB.confirmado = false
            }

            $("#inputDesde").bind("change", invalidarMarkers)
            $("#inputHasta").bind("change", invalidarMarkers)

            function input_press_enter(e){
                if (e.which == 13){
                    e.preventDefault();
                    piwikLog("/click/buscar/enter/"+$("#inputDesde").val()+"/"+$("#inputHasta").val())
                    buscar_por_inputs();                    
                }
            }

            $("#inputDesde").keypress(input_press_enter);
            $("#inputHasta").keypress(input_press_enter);

            $("#button-buscarinputs").bind("click", function(e) {
                e.preventDefault();
                piwikLog("/click/buscar/button/"+$("#inputDesde").val()+"/"+$("#inputHasta").val())
                buscar_por_inputs();
            })

            $("#button-origendestino").bind("click", function(e) {
                e.preventDefault()
                piwikLog("/click/botonera/darVuelta")
                desde = $("#inputDesde").val()
                hasta = $("#inputHasta").val()
                if ( $.trim(desde) != '' && $.trim(hasta) != '' ) {
                    $("#inputDesde").val(hasta)
                    $("#inputHasta").val(desde)
                }
                if ( markerA.confirmado && markerB.confirmado ) {
                    ma = new OpenLayers.Geometry.Point(markerA.centro.x, markerA.centro.y)
                    mb = new OpenLayers.Geometry.Point(markerB.centro.x, markerB.centro.y)
                    markerA.setPoint(mb)
                    markerAaux.setPoint(mb)
                    markerB.setPoint(ma)
                    markerBaux.setPoint(ma)
                    // buscar sobre los markers
                    buscarporclick(markerA.centro, markerB.centro)
                }
                else {
                    // buscar sobre los textbox
                    buscar_por_inputs()
                }
            })

            // bind eventos click partes dinamicas de la pagina (bind multiple)
            function bindearEventos(porNombre) {
                var selectorDiv = '#sidebarResultadosPorNombre'
                if (!porNombre) {
                    $("#button_buscar_transbordo:not(binded)").bind("click", function(e) {
                        e.preventDefault();
                        piwikLog("/click/buscar/transbordo")
                        buscarTransbordo();
                        $(this).addClass("binded");
                    })

                    $("#button-seleccionarSugerencias:not(binded)").bind("click", function(e) {
                        e.preventDefault();
                        //trackear nombre de seleccionadas
                        piwikLog("/click/buscar/suggest/")
                        seleccionarSugerencias();
                        $(this).addClass("binded");
                    })

                    $(".marcarSuggest:not(binded)").bind("click", function(e) {
                        e.preventDefault();
                        marcarPunto(
                            $(this).attr("data_geom"),
                            $(this).attr("data_id"),
                            $(this).attr("data_domId")
                        );
                        $(this).addClass("binded");
                    })
                    
                    selectorDiv = '#sidebarResultados'; 
                }

                $(selectorDiv + " div.pagination a[href]:not(binded)").bind("click", function(e) {
                    e.preventDefault();
                    n = $(this).attr("data_pagina");
                    if      ( n <  0 ) pps = "ant";
                    else if ( n == 0 ) pps = "sig";
                    else if ( n >  0 ) pps = n;
                    piwikLog("/click/pagina/"+pps)
                    pasarPagina($(this).attr("data_pagina"), $(this).attr("combinar"), porNombre);
                    //console.log("porNombre="+porNombre)
                    //console.log("n="+n)
                    $(this).addClass("binded");
                })
            }

            if ($("#inputDesde").val() != "" && $("#inputHasta").val() != ""){
                buscar_por_inputs();
            }
            
            $('a[data-toggle="tab"]').on('shown', function (e) {
                if ( $(e.target).attr('href')=='#1' )
                    mostrar_resultado(undefined, false)
                else
                    mostrar_resultado(undefined, true);
            })

        })
        </script>

        <script id="ajaxLoader" type="text/x-jquery-tmpl">
            <center>
                <img src="/media/img/ajax-loader.gif" />
            </center>
        </script>

        <script id="listTempl" type="text/x-jquery-tmpl">
            <div>
                <div style="float:left;"><small>Página ${data['p']} de ${data['cant_paginas']}</small></div>
                <div style="float:right;"><small class="pull-right">${data['cant']} resultados</small></div>
                <div style="clear:both;"></div>
            </div>
            <div>
                <ul class="nav nav-pills nav-stacked">
                    {% templatetag openvariable %}tmpl(data['resultados']) "#itemTempl"{% templatetag closevariable %}
                </ul>
                {% templatetag openvariable %}tmpl(data) "#paginacionTempl"{% templatetag closevariable %}
            </div>
        </script>

        <script id="itemTempl" type="text/x-jquery-tmpl">
            <li id="res${id}">
                <a href="#" id="${id}">
                    {% templatetag openvariable %}each itinerario{% templatetag closevariable %}
                        <div style="margin:0; padding:0">
                            <img src="/media/img/micros/30x35/${foto}.png" style="float:left; margin-top: 4px; margin-right: 4px"/>
                            <strong>${nombre}</strong>
                            <br>
                            de ${inicio} a ${fin}
                            <br>
                            distancia: {% templatetag openvariable %}if long_pata{% templatetag closevariable %}${Math.round(long_pata)} m (pie) + {% templatetag openvariable %}/if{% templatetag closevariable %}${Math.round(long_bondi/100)/10} km (bondi)
                        </div>
                    {% templatetag openvariable %}/each{% templatetag closevariable %}
                </a>
            </li>
        </script>

        <script id="paginacionTempl" type="text/x-jquery-tmpl">
        {% templatetag openvariable %}if Math.ceil(cant/long_pagina) > 1{% templatetag closevariable %}
            <div class="pagination pagination-centered">
                <ul>
                    {% templatetag openvariable %}if p > 1{% templatetag closevariable %}
                        <li><a href="#" data_pagina="-1" combinar="${combinar}">«</a></li>
                    {% templatetag openvariable %}/if{% templatetag closevariable %}

                    {% templatetag openvariable %}each page_list{% templatetag closevariable %}
                        <li><a href="#" data_pagina="${$value}" combinar="${combinar}">${$value}</a></li>
                    {% templatetag openvariable %}/each{% templatetag closevariable %}

                    {% templatetag openvariable %}if p < Math.ceil(cant/long_pagina){% templatetag closevariable %}
                        <li><a href="#" data_pagina="0" combinar="${combinar}">»</a></li>
                    {% templatetag openvariable %}/if{% templatetag closevariable %}
                </ul>
            </div>
        {% templatetag openvariable %}/if{% templatetag closevariable %}
        </script>

        <script id="listSuggest" type="text/x-jquery-tmpl">
        <p>Seleccione la opción correcta</p>
        <div class="well sidebar-nav">
            <ul class="nav nav-list">
                <li class="nav-header">Origen:</li>
            </ul>
            <ul id="#sug1" class="nav nav-list">
                {% templatetag openvariable %}tmpl(data1) "#itemSuggest"{% templatetag closevariable %}
            </ul>
            <ul class="nav nav-list">
                <li class="nav-header">Destino:</li>
            </ul>
            <ul id="#sug2" class="nav nav-list">
                {% templatetag openvariable %}tmpl(data2) "#itemSuggest"{% templatetag closevariable %}
            </ul>
            <div>
                &nbsp;
                <button id="button-seleccionarSugerencias" class="btn btn-primary pull-right" type="submit">Aceptar</button>
            </div>
        </ul>
        </script>
        <script id="itemSuggest" type="text/x-jquery-tmpl">
            <li id="sug${domId}{porNombre}">
                <a class="marcarSuggest" href="#" data_geom="${geom}" data_id="${id}" data_domId="${domId}">${nombre} <span class="distancia">(${(precision*100).toFixed(2)}%)</span></a>
            </li>
        </script>

        <script id="ayudaTempl" type="text/x-jquery-tmpl">
           <h3>¿Como busco recorridos?</h3>
           <h4>Campos de búsqueda</h4>
           <p>Escriba directamente en los campos de texto del panel superior. Puede considerar interseccion de calles, calle y número o lugares de interes. Vea los ejemplos debajo de los campos de búsqueda.</p>
           <h4>Click sobre el mapa</h4>
           <p> hacer click directamente sobre el mapa para indicar el Origen y Destino de su búsqueda. Luego puede arrastrar los marcadores A o B para editar su ubicación.</p>
           <h4>Lineas de micro</h4>
           <p>Para buscar un recorrido completo de una linea de colectivo en particular, consulte la sección "Recorridos" aqui arriba.</p>
        </script>

        <script id="vacio1Templ" type="text/x-jquery-tmpl">
           <h3>No se encontraron resultados sin transbordo</h3>
           <p>Si igualmente desea buscar con transbordo, presione el siguiente botón.</p>
           <button id="button_buscar_transbordo" class="btn btn-primary">Buscar con Transbordo</button>
        </script>
        <script id="vacio2Templ" type="text/x-jquery-tmpl">
           <h3>No se encontraron resultados con transbordo</h3>
           <p>Puede intentar haciendo click en el mapa para posicionar marcadores de inicio y fin de recorrido o bien mover los marcadores si ya se encuentran en el mapa.</p>
        </script>
        <script id="vacioTempl" type="text/x-jquery-tmpl">
           <h3>No se encontraron resultados</h3>
           <p>Puede intentar nuevamente modificando el nombre de la línea que está buscando por algo mas genérico.</p>
        </script>
{% endblock %}
