{% extends "maquetado.html" %}
{% load comments %}

{% block bloque_izquierda %}
    <ul class="breadcrumb">
        <li><a href="/">Inicio</a> <span class="divider">></span></li>
        <li class="active">{{ciudad_actual.nombre}}</li>
    </ul>

    <h1>{{ciudad_actual.nombre}}</h1>

    <table class="table table-striped table-bordered table-condensed">
        <thead>
            <tr>
            <th>Nombre de la linea</th>
            </tr>
        </thead>
        <tbody>
        {% for linea in lineas %}
            <tr>
                <td><a href="{{linea.slug}}">{{linea.nombre}}</a></td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <h3>Comentarios:</h3>
    {% render_comment_list for ciudad_actual %}

	{% if user.is_authenticated %}
    	{% get_comment_form for ciudad_actual as form %}
    	<div class='row'>
    		<div id='nuevo-comentario' class='span8'>
    			<h3>Dejanos un comentario:</h3>
                <div id="mensajes-comments"></div>
		    	<form id="comment-form" action="/comments/post/" method="POST" class="well">
		    		{% csrf_token %}
		    		{{ form.content_type }} 
					{{ form.object_pk }}
					{{ form.timestamp }}
					{{ form.security_hash }}
		    		<textarea class="span7" name='comment' id="textarea" rows="3" placeholder="Tu Comentario..."></textarea>
		    		<input type="hidden" name="next" value="{% url ver_ciudad ciudad_actual.slug %}" />
					<input type="hidden" name="honeypot" id="id_honeypot" />
					<br />
					<button type="submit" class="btn"><i class="icon-comment"></i> Enviar comentario</button>
				</form>
			</div>
		</div>
	{% else %}
		<h4>Para dejar un comentario debes <a href="/account/login/">loguearte</a></h4>
	{% endif %}

{% endblock %}

{% block custom_ready_function %}
    $("#comment-form").submit(function(event){
        event.preventDefault();
        $.post('/comments/post/',
               $(this).serialize(),
               function(data) {
                    if (data['exito']==true){
                        alert_html = '<div style="width: 780px;" class="alert alert-success fade in" align="center">'
                        alert_html += '<a class="close" data-dismiss="alert" href="#">×</a>Comentario agregado correctamente!</div>'
                        dibujar_comentario(data['comentario'], data['usuario'], data['fecha']);
                    }else{
                        alert_html = '<div style="width: 780px;" class="alert alert-error fade in" align="center">'
                        alert_html += '<a class="close" data-dismiss="alert" href="#">×</a>Algo anduvo mal...</div>'
                    }
                    $("#mensajes-comments").html(alert_html)
               },
               'json'
        );
    })
{% endblock %}

