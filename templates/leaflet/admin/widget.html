{% extends "leaflet/widget.html" %}
{% load i18n %}
{% load static from staticfiles %}


{% block map_css %}
    {{ block.super }}

    /* Fixes for Django base.css */
    .module .leaflet-draw ul {
        margin-left: 0px;
        padding-left: 0px;
    }
    .module .leaflet-draw ul li {
        list-style-type: none;
    }

    .sortable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
    .sortable li { margin: 0 3px 3px 3px; padding: 0.4em; padding-left: 1.5em; font-size: 1.4em; height: 18px; }
    .sortable li span { position: absolute; margin-left: -1.3em; }
{% endblock map_css %}


{% block vars %}
    {{ block.super }}

    {% include "leaflet/_leaflet_draw_i18n.js" %}
    L.Control.ResetView.TITLE = "{% trans "Reset view" %}";
    L.Control.ResetView.ICON = "url({% static "leaflet/images/reset-view.png" %})";
{% endblock vars %}

{% block map %}
<div id="{{ id }}_div_map">
    {{ block.super }}
</div>
<div>
    <div>
        <label for="{{ id }}_xml_parser">osm rel id:</label>
        <input id="{{ id }}_xml_parser_input" class="vTextField" type="text"></input>
        <button id="{{ id }}_xml_parser_button">Parse!</button>
    </div>
    <div id="{{ id }}_xml_parser_partes" class="sortable"></div>
    <script>var jQuery=django.jQuery;</script>
    <script src="//code.jquery.com/ui/1.11.3/jquery-ui.min.js" type="text/javascript"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.3/themes/smoothness/jquery-ui.css">
    <script>

        // override {{id}}_map_callback para obtener el map y poder hacer el reoladmapa
        // override de http://stackoverflow.com/questions/296667/overriding-a-javascript-function-while-referencing-the-original/296713#296713
        var {{id}}_reloadmapa = null;
        var {{id}}_map = null;
        (function() {
            var proxied = {{id}}_map_callback;
            {{id}}_map_callback = function() {
                var map = arguments[0];
                {{id}}_map = map;
                map.on("map:loadfield", function(field, fieldid) {
                    {{id}}_reloadmapa = function () {
                        field.field.load();
                    };
                }); 
                return proxied.apply( this, arguments );
            };
        })();




        (function($) {

            $("#{{ id }}_xml_parser_partes").sortable();

            function getnode($data, id) {
                $node = $data.find('#'+id);
                return [ $node.attr("lon") , $node.attr("lat") ]
                //return "[" + $node.attr("lon") + "," + $node.attr("lat") + "]";
            }

            function arraysEqual(a, b) {
                if (a === b) return true;
                if (a == null || b == null) return false;
                if (a.length != b.length) return false;

                // If you don't care about the order of the elements inside
                // the array, you should sort both arrays here.

                for (var i = 0; i < a.length; ++i) {
                    if (a[i] !== b[i]) return false;
                }
                return true;
            }

            function repintar(a) {
                var s = [];
                var arr = $("#{{ id }}_xml_parser_partes").sortable('toArray');
                for ( var ii = 0; ii < arr.length; ii++ ) {
                    var i = arr[ii];
                    for ( var j = 0; j < a[i].length; j++ )
                        s.push("[" + a[i][j][0] + "," + a[i][j][1] + "]");
                }

                $("#{{id}}").val('{ "type": "LineString", "coordinates": ['+s.join(",")+']}');

                {{id}}_map.eachLayer(function (layer) {
                    if ( layer.hasOwnProperty("_latlngs") )
                        {{id}}_map.removeLayer(layer);
                });
                {{id}}_reloadmapa();
            }

            $("#{{ id }}_xml_parser_button").on("click", function(e){
                $.ajax({
                    url: "http://api.openstreetmap.org/api/0.6/relation/"+$("#{{ id }}_xml_parser_input").val()+"/full",
                    success: function(data) {
                        var a = [];
                        $data = $(data);
                        // obtener los ways como arrays de latlng [[[lon,lat]]]
                        $data.find("relation").first().find("member").each(function() {
                            var $this = $(this);
                            var w = [];
                            //if ( $this.attr("type") == "node" )
                            // ESTOS SON PARADAS: no me sirven por ahora
                            //    w.push(getnode($data, $this.attr("ref")));
                            //else 
                            if ( $this.attr("type") == "way" ) 
                                $data.find('#'+$this.attr("ref")).first().find("nd").each(function() {
                                    var $this = $(this);
                                    w.push(getnode($data, $this.attr("ref")));
                                })
                            if ( w.length > 1 ) a.push(w);
                        })
                        
                        // unir los ways en varias pasadas
                        var cambia = true
                        while (cambia) {
                            cambia = false;

                            // fin1 == ini2
                            var a2 = [];
                            for ( var i = 0; i < a.length; i++ ) {
                                var ini1 = a[i][0];
                                var fin1 = a[i][a[i].length - 1];
                                var found = false;
                                for ( var j = 0; j < a2.length; j++ ) {
                                    var ini2 = a2[j][0];
                                    var fin2 = a2[j][a2[j].length - 1];
                                    if ( arraysEqual(fin1, ini2) ) {
                                        a2[j] = a[i].concat(a2[j].slice(1));
                                        found = true;
                                        cambia = true;
                                    }
                                }
                                if ( ! found )
                                    a2.push(a[i]);
                            }
                            a = a2

                            // ini1 == fin2
                            var a2 = [];
                            for ( var i = 0; i < a.length; i++ ) {
                                var ini1 = a[i][0];
                                var fin1 = a[i][a[i].length - 1];
                                var found = false;
                                for ( var j = 0; j < a2.length; j++ ) {
                                    var ini2 = a2[j][0];
                                    var fin2 = a2[j][a2[j].length - 1];
                                    if ( arraysEqual(ini1, fin2) ) {
                                        a2[j] = a2[j].concat(a[i].slice(1));
                                        found = true;
                                        cambia = true;
                                    }
                                }
                                if ( ! found )
                                    a2.push(a[i]);
                            }
                            a = a2

                            // ini1 == ini2 (hay que dar vuelta uno)
                            var a2 = [];
                            for ( var i = 0; i < a.length; i++ ) {
                                var ini1 = a[i][0];
                                var fin1 = a[i][a[i].length - 1];
                                var found = false;
                                for ( var j = 0; j < a2.length; j++ ) {
                                    var ini2 = a2[j][0];
                                    var fin2 = a2[j][a2[j].length - 1];
                                    if ( arraysEqual(ini1, ini2) ) {
                                        a2[j] = a[i].slice().reverse().concat(a2[j].slice(1));
                                        found = true;
                                        cambia = true;
                                    }
                                }
                                if ( ! found )
                                    a2.push(a[i]);
                            }
                            a = a2

                            // fin1 == fin2 (hay que dar vuelta uno)
                            var a2 = [];
                            for ( var i = 0; i < a.length; i++ ) {
                                var ini1 = a[i][0];
                                var fin1 = a[i][a[i].length - 1];
                                var found = false;
                                for ( var j = 0; j < a2.length; j++ ) {
                                    var ini2 = a2[j][0];
                                    var fin2 = a2[j][a2[j].length - 1];
                                    if ( arraysEqual(fin2, fin1) ) {
                                        a2[j] = a2[j].concat(a[i].slice().reverse().slice(1));
                                        found = true;
                                        cambia = true;
                                    }
                                }
                                if ( ! found )
                                    a2.push(a[i]);
                            }
                            a = a2
                        }

                        var $list=$("#{{ id }}_xml_parser_partes");
                        $list.sortable("destroy"); //call widget-function destroy
                        $list.find("li").removeClass('ui-state-default');
                        $list.find("li span").remove();
                        $list.sortable();
                        $list.disableSelection();
                        $list.on( "sortstop", function(){ repintar(a) } );
                        $list.text("");
                        for ( var i = 0; i < a.length; i++ ) {
                            var $n = $('<li id="'+i+'" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>Tramo '+i+'</li>');
                            $list.append($n);
                        }
                        repintar(a);

                    },
                    error: function() {
                        alert('error');
                    }
                });
                e.preventDefault();
                return false
            });
        })(django.jQuery);
    </script>
</div>
{% endblock map %}